<?php// No direct access to this filedefined('_JEXEC') or die('Restricted access'); // import Joomla view libraryjimport('joomla.application.component.view'); /** * HTML View class for the HelloWorld Component */class ReferidosViewOtroPlan extends JView{		public $caracteristicas;		public $planes;		public $plan;		public $orden;		public $user;		        // Overwriting JView display method        function display($tpl = null)         {                // Check for errors.                if (count($errors = $this->get('Errors')))                 {                        JError::raiseError(500, implode('<br />', $errors));                        return false;                }								//obtengo las caracteristicas				$this->getCaracteristicas();								//obtengo los planes				$this->getPlanes();								//obtengo la orden para legalizar				$this->ordenPlan();				                // Display the view                parent::display($tpl);        }				/*		* Get caracteristicas		*		*/		public function getCaracteristicas(){			$model_caracteristica = new ReferidosModelCaracteristica();			$wheres = array(				0 => (object) array(						'key' => 'estado_activo'					,	'condition' => ' = '					,	'value' => '1'					,	'glue' => ''				)			);			$this->caracteristicas = $model_caracteristica->getObjects( $wheres ); 		}				/*		* Get planes		*		*/		public function getPlanes(){						$model_plan = new ReferidosModelPlan();			$wheres = array(				0 => (object) array(						'key' => 'estado_activo'					,	'condition' => ' = '					,	'value' => '1'					,	'glue' => 'AND'				)				,				1 => (object) array(						'key' => 'tipo_plan'					,	'condition' => ' = '					,	'value' => '1'					,	'glue' => ''				)			);			$this->planes = $model_plan->getObjects( $wheres ); 		}				/*		* obtener caracteristicas de plan		* @param { int , int} id plan , id caracteristica		*/		public function caracteristicaPlan( $id_plan , $id_caracteristica ){						if( !is_numeric( $id_plan ) || !is_numeric( $id_caracteristica ) )				return ( object ) array();			//return var_dump( $id_plan , $id_caracteristica );						$model_plan = new ReferidosModelPlan();						$wheres = array(				0 => ( object ) array(						'key' => 'a.id_caracteristica'					,	'condition' => ' = '					,	'value' => $id_caracteristica					,	'glue' => ''				)			);						$model_plan->instance( $id_plan ); 			$objs = $model_plan->getCaracteristicasPlan( $wheres );						return $objs[ 0 ];		}				/*		* get orden plan		* @param { }		*/		public function ordenPlan(){						$user = JFactory::getUser();			$app = JFactory::getApplication();						$model_user = new ReferidosModelUser();			$model_orden = new ReferidosModelOrdenPlan();			$model_plan = new ReferidosModelPlan();						$planact = $app->getUserState( 'planact' );			$id_orden = $app->getUserState( 'id_orden' );						//instancio la clase orden			$model_orden->instance( $id_orden );			$this->orden = $model_orden;						//instancio la clase usuario			$model_user->instance( (int) $user->get('id') );			$this->user = $model_user;			$inf_user = $model_user->getUserInf();			foreach( $inf_user as $attr=>$valor){				$this->user->$attr = $valor;			}						//instancio la clase plan			$model_plan->instance( ( int ) $model_orden->id_plan );			$this->plan = $model_plan;					}		/**		* comprar plan referidos		* @params { array } parrametros a usar		* @return { void }		*/		protected function pay( $datas ){			$uri = JFactory::getURI();			$user = JFactory::getUser();			$model_pago = new PagoModel();			$Utilities = new Misc();						$url_res = $uri->root().'index.php?option=com_referidos&task=plan.responsepay';			$url_conf = $uri->root().'index.php?option=com_referidos&task=plan.confirmationpay';						$text_encript = $datas[ 'orden' ].'_'.$datas[ 'plan' ].'_'.$user->get( 'id' );			$text_encript = $Utilities::Encrypt( $text_encript );						/*$args = array(					'refVenta' => $text_encript				,	'description' => "Test PAYU"				,	'valor' => 3				,	'iva' => 0				,	'basevalor' => 0				,	'comprador_email' => $datas[ 'emailuser' ]				,	'comprador_name' => rtrim( $datas[ 'nameuser' ] )				,	'currency' => "USD"				,	'url_respuesta' => $url_res				,	'url_confirmacion' => $url_conf			);*/						$args = array(					'refVenta' => $text_encript				,	'description' => 'Plan Referidos : '.$datas[ 'nomplan' ]				,	'valor' => number_format( $datas[ 'valorpesos' ] , 2 , '.' , '')				,	'iva' => 0				,	'basevalor' => 0				,	'comprador_email' => $datas[ 'emailuser' ]				,	'comprador_name' => $datas[ 'nameuser' ]				,	'currency' => 'COP'				,	'url_respuesta' => $url_res				,	'url_confirmacion' => $url_conf			);						//instancio la clase de pago y le paso los argumentos			$model_pago->instance( $args );			$model_pago->getForm( $datas[ 'btn_input' ] );		}}