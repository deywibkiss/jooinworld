<?php defined( '_JEXEC' ) or die( 'Restricted access' );  jimport( 'joomla.application.component.controller' ); class ReferidosControllerPlan extends JController{		/**	* Save or update a register	* Call the model passing args	*	*/	public function save(){				$caracteristicas = array();		$id_plan = JRequest::getInt( 'id' );		$user = JFactory::getUser();				$args = array(				'id_plan' => ( !empty( $id_plan ) ) ? $id_plan : NULL 			,	'estado_activo' => JRequest::getVar( 'disponibilidad' )			,	'nom_plan' => JRequest::getVar( 'nombre_plan' )			,	'descripcion' => JRequest::getVar( 'descripcion' )			,	'modified' => date( 'Y-m-d H:i:s' )			,	'modified_by' => $user->get('id')			,	'niveles' => JRequest::getVar( 'niveles' )			,	'personas_nivel' => JRequest::getVar( 'personasxnivel' )			,	'comision_x_persona' => JRequest::getVar( 'comisionxpersona' )			,	'personas' => NULL			,	'orden' => JRequest::getVar( 'orden' )			,	'valor_pesos' => JRequest::getVar( 'valorpesos' )			,	'valor_dolares' => JRequest::getVar( 'valordolar' )			,	'tipo_plan' => JRequest::getVar( 'tipo_plan' )		);				$args_created = array(				'created' => date( 'Y-m-d H:i:s' )			,	'created_by' => $user->get( 'id' )		);				if( empty( $id_plan ) )			$args = array_merge( $args , $args_created);				$caracteristicas = JRequest::getVar( 'caracteristicasids' );		if( !is_array( $caracteristicas ))			$caracteristicas[] = $caracteristicas;					$valorcaract = JRequest::getVar( 'valor' );		if( !is_array( $valorcaract ) )			$valorcaract[] = $valorcaract;			// Get the model		$model = $this->getModel('plan');		// Fill the model attributes with args		$model->instance( $args );		//save the model into DB		$respuesta = $model->save( 'bool' );			if( $respuesta ){						//agregar registros para referencia de las caracteristicas de los planes			foreach( $caracteristicas as $key=>$id_ca ){								$args_plan_caracteristica = array(						'id_caracteristica' => $id_ca					,	'valor' => $valorcaract[ $key ]							,	'tipo' => ''					,	'created' => date( 'Y-m-d H:i:s' )					,	'created_by' => $user->get('id')				);								$model->savePlanCaracteristica( $args_plan_caracteristica );			}						//obtengo todas las caracteristicas y compruebo si se ha eliminado alguna en la vista			$all_caract = $model->getCaracteristicasPlan( array() , array( 'load' => 'loadObjectList') );			foreach( $all_caract as $key=>$caract){								if( !in_array( $caract->id_caracteristica, $caracteristicas ) )					$model::deleteCaractPlan( ( int ) $caract->id_caracteristica_plan );			}							$this->setRedirect("index.php?option=com_referidos&view=planes");			return;						}else{						$this->setMessage( 'No se creo el plan : '.$respuesta , 'error');				$this->setRedirect( "index.php?option=com_referidos&view=planes" );			return;						}		}		/**	* Save or update a register	* Call the model passing args	*	*/	public function apply(){				$caracteristicas = array();		$id_plan = JRequest::getInt( 'id' );		$user = JFactory::getUser();				$args = array(				'id_plan' => ( !empty( $id_plan ) ) ? $id_plan : NULL 			,	'estado_activo' => JRequest::getVar( 'disponibilidad' )			,	'nom_plan' => JRequest::getVar( 'nombre_plan' )			,	'descripcion' => JRequest::getVar( 'descripcion' )			,	'modified' => date( 'Y-m-d H:i:s' )			,	'modified_by' => $user->get('id')			,	'niveles' => JRequest::getVar( 'niveles' )			,	'personas_nivel' => JRequest::getVar( 'personasxnivel' )			,	'comision_x_persona' => JRequest::getVar( 'comisionxpersona' )			,	'personas' => NULL			,	'orden' => JRequest::getVar( 'orden' )			,	'valor_pesos' => JRequest::getVar( 'valorpesos' )			,	'valor_dolares' => JRequest::getVar( 'valordolar' )			,	'tipo_plan' => JRequest::getVar( 'tipo_plan' )		);				$args_created = array(				'created' => date( 'Y-m-d H:i:s' )			,	'created_by' => $user->get( 'id' )		);				if( empty( $id_plan ) )			$args = array_merge( $args , $args_created);				$caracteristicas = JRequest::getVar( 'caracteristicasids' );		if( !is_array( $caracteristicas ))			$caracteristicas[] = $caracteristicas;					$valorcaract = JRequest::getVar( 'valor' );		if( !is_array( $valorcaract ) )			$valorcaract[] = $valorcaract;		// Get the model		$model = $this->getModel('plan');		// Fill the model attributes with args		$model->instance( $args );		//save the model into DB		$respuesta = $model->save( 'bool' );				//var_dump( $model->save( 'object' ) ); die;			if( $respuesta ){						//agregar registros para referencia de las caracteristicas de los planes			foreach( $caracteristicas as $key=>$id_ca ){							$args_plan_caracteristica = array(						'id_caracteristica' => $id_ca					,	'valor' => $valorcaract[ $key ]							,	'tipo' => ''					,	'created' => date( 'Y-m-d H:i:s' )					,	'created_by' => $user->get('id')				);								$model->savePlanCaracteristica( $args_plan_caracteristica );			}						//obtengo todas las caracteristicas y compruebo si se ha eliminado alguna en la vista			$all_caract = $model->getCaracteristicasPlan( array() , array( 'load' => 'loadObjectList') );			foreach( $all_caract as $key=>$caract){								if( !in_array( $caract->id_caracteristica, $caracteristicas ) )					$model::deleteCaractPlan( ( int ) $caract->id_caracteristica_plan );			}						$id_redirect = ( !empty($model->insertId) ) ? $model->insertId : $model->id_plan;				$this->setRedirect( JRoute::_( "index.php?option=com_referidos&view=createplan&layout=edit&id=". $id_redirect , false) );			return;						}else{						$id_redirect = ( !empty($model->insertId) ) ? $model->insertId : $model->id_plan;			$this->setMessage( 'No se creo el plan : '.$respuesta , 'error');				$this->setRedirect( JRoute::_( "index.php?option=com_referidos&view=createplan&layout=edit&id=". $id_redirect , false) );			return;						}		}		/**	* Save or update a register	* Call the model passing args	*	*/	public function save2new(){				$caracteristicas = array();		$id_plan = JRequest::getInt( 'id' );		$user = JFactory::getUser();				$args = array(				'id_plan' => ( !empty( $id_plan ) ) ? $id_plan : NULL 			,	'estado_activo' => JRequest::getVar( 'disponibilidad' )			,	'nom_plan' => JRequest::getVar( 'nombre_plan' )			,	'descripcion' => JRequest::getVar( 'descripcion' )			,	'modified' => date( 'Y-m-d H:i:s' )			,	'modified_by' => $user->get('id')			,	'niveles' => JRequest::getVar( 'niveles' )			,	'personas_nivel' => JRequest::getVar( 'personasxnivel' )			,	'comision_x_persona' => JRequest::getVar( 'comisionxpersona' )			,	'personas' => NULL			,	'orden' => JRequest::getVar( 'orden' )			,	'valor_pesos' => JRequest::getVar( 'valorpesos' )			,	'valor_dolares' => JRequest::getVar( 'valordolar' )			,	'tipo_plan' => JRequest::getVar( 'tipo_plan' )		);				$args_created = array(				'created' => date( 'Y-m-d H:i:s' )			,	'created_by' => $user->get( 'id' )		);				if( empty( $id_plan ) )			$args = array_merge( $args , $args_created);				$caracteristicas = JRequest::getVar( 'caracteristicasids' );		if( !is_array( $caracteristicas ))			$caracteristicas[] = $caracteristicas;					$valorcaract = JRequest::getVar( 'valor' );		if( !is_array( $valorcaract ) )			$valorcaract[] = $valorcaract;						// Get the model		$model = $this->getModel('plan');		// Fill the model attributes with args		$model->instance( $args );		//save the model into DB		$respuesta = $model->save( 'bool' );			if( $respuesta ){						//agregar registros para referencia de las caracteristicas de los planes			foreach( $caracteristicas as $key=>$id_ca ){							$args_plan_caracteristica = array(						'id_caracteristica' => $id_ca					,	'valor' => $valorcaract[ $key ]							,	'tipo' => ''					,	'created' => date( 'Y-m-d H:i:s' )					,	'created_by' => $user->get('id')				);								$model->savePlanCaracteristica( $args_plan_caracteristica );			}						//obtengo todas las caracteristicas y compruebo si se ha eliminado alguna en la vista			$all_caract = $model->getCaracteristicasPlan( array() , array( 'load' => 'loadObjectList') );			foreach( $all_caract as $key=>$caract){								if( !in_array( $caract->id_caracteristica, $caracteristicas ) )					$model::deleteCaractPlan( ( int ) $caract->id_caracteristica_plan );			}							$this->setRedirect("index.php?option=com_referidos&view=creteplan&layout=edit");			return;						}else{						$this->setMessage( 'No se creo el plan : '.$respuesta , 'error');				$this->setRedirect( "index.php?option=com_referidos&view=creteplan&layout=edit" );			return;						}		}		/**	 *  Task that deletes the list of Informes Seguimiento	 */	public function delete(){				//Het the items picked		$pks = JRequest::getVar( 'cid' );		//Instance a model for each item and delete		foreach ( $pks as $id ) {						// Call the model			$model = $this->getModel( 'plan' );						$model->instance( $id );			$model->delete();					}		$this->setRedirect( "index.php?option=com_referidos&view=planes" );		return;	}		public function buscar(){		$modelo = $this->getModel('plan');		$modelo->setParams();		$this->setRedirect( "index.php?option=com_referidos&view=planes" );		return;	}	public function limpiar(){		$modelo = $this->getModel('plan');		$modelo->cleanParams();		$this->setRedirect( "index.php?option=com_referidos&view=planes" );		return;	}		/**	 *  Task that publishes the list of Informes Seguimiento	 */	public function publish(){				//Het the items picked		$pks = JRequest::getVar( 'cid' );		//Instance a model for each item and delete		foreach ( $pks as $id ) {						// Call the model			$model = $this->getModel( 'plan' );			$args = array(				'id_plan' => $id,				'estado_activo' => 0			);						$model->instance( $args );			$model->publish();					}		$this->setRedirect( JRoute::_( "index.php?option=com_referidos&view=planes" , false) );		return;	}  		/**	 *  Task that unpublishes the list of Informes Seguimiento	 */	public function unpublish(){				//Het the items picked		$pks = JRequest::getVar( 'cid' );		//Instance a model for each item and delete		foreach ( $pks as $id ) {						// Call the model			$model = $this->getModel( 'plan' );			$args = array(				'id_plan' => $id,				'estado_activo' => 1			);						$model->instance( $args );			$model->publish();					}		$this->setRedirect( "index.php?option=com_referidos&view=planes" );		return;	}      	/**	* Make a model request to publish or unpublish an informe	*	*	*/	public function publicar(){		$id = JRequest::getVar("id");		$model = $this->getModel( 'plan' );		$model->instance($id);		echo $model->publish( 'bool' );				die();	}		/**	* redirecciona al layout de creacion de plan	*	*/	public function create(){		$this->setRedirect( 'index.php?option=com_referidos&view=createplan&layout=edit' );		return;	}		/**	* redirecciona al layout de edicion de plan	*	*/	public function edit(){				//Het the items picked		$cid = JRequest::getVar( 'cid' );		if( count( $cid )  > 1){			$this->setRedirect( 'index.php?option=com_referidos&view=planes' , 'Seleccione solo un item para editar' , 'error');			return;		}				$this->setRedirect( 'index.php?option=com_referidos&view=createplan&layout=edit&id='.$cid[ 0 ] );		return;	}		/**	* redirecciona a la grilla de planes	*	*/	public function cancel(){		$this->setRedirect( 'index.php?option=com_referidos&view=planes' );		return;	}	}