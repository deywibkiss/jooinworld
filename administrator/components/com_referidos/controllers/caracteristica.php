<?php defined( '_JEXEC' ) or die( 'Restricted access' ); //Import filesystem libraries.jimport('joomla.filesystem.file'); jimport( 'joomla.application.component.controller' ); class ReferidosControllerCaracteristica extends JController{		/**	* Save or update a register	* Call the model passing args	*	*/	public function save(){				$id_caracteristica = JRequest::getInt( 'id' );		$user = JFactory::getUser();		$file = JRequest::getVar('load_icono', null, 'files', 'array');				//upload image		$file_types = array( 'jpeg' , 'png' , 'jpg' );		$result_img = $this->fileUpload( $file , 2097152 , JPATH_ROOT.'/images/icons_planes' , $file_types );		if( !$result_img[ 'success' ] && $file[ 'name' ] != ''){						$this->setMessage( 'No se pudo cargar la imagen : '.$result_img[ 'msg' ], 'error');				$this->setRedirect( "index.php?option=com_referidos&view=caracteristicas" );			return;		}			$args = array(				'id_caracteristica' => ( !empty( $id_caracteristica ) ) ? $id_caracteristica : NULL			,	'caracteristicas' => JRequest::getVar( 'caracteristica' )			,	'descripcion' => JRequest::getVar( 'descripcion' )			,	'estado_activo' => JRequest::getVar( 'disponibilidad' )			,	'tipo_caracteristica' => JRequest::getVar( 'tipo' )			,	'points_cumple' => NULL			,	'modified' => date( 'Y-m-d H:i:s')			,	'modified_by' => $user->get('id')			,	'show_home' => JRequest::getVar( 'show_home' )		);				//si el registro es nuevo se agregan los otros argumentos		$args_created = array(				'created' => date( 'Y-m-d H:i:s' )			,	'created_by' => $user->get( 'id' )		);		if( empty( $id_caracteristica ) )			$args = array_merge( $args , $args_created);				//si la imagen se carga se almacena			$args_img = array(				'path_icono' => 'images/icons_planes/'.$result_img[ 'filename' ]			,	'icono' => $result_img[ 'filename' ]		);			if( $file[ 'name' ] != ''  )			$args = array_merge( $args , $args_img);		// Get the model		$model = $this->getModel('caracteristica');		// Fill the model attributes with args		$model->instance( $args );		//save the model into DB		$respuesta = $model->save( 'bool' );			if( $respuesta ){						$this->setRedirect("index.php?option=com_referidos&view=caracteristicas");			return;						}else{						$this->setMessage( 'No se creo la Caracteristica : '.$respuesta , 'error');				$this->setRedirect( "index.php?option=com_referidos&view=caracteristicas" );			return;						}		}		/**	* metodo para cargar archivos	* @params { array | int | string | array/string } 	* @return bool	*/	protected function fileUpload( $file, $max, $module_dir, $file_type ){		        // Retorna: Array ( [name] => mod_simpleupload_1.2.1.zip [type] => application/zip         // [tmp_name] => /tmp/phpo3VG9F [error] => 0 [size] => 4463 ) 		if( !is_array($file_type) && $file_type != '*' )			$file_type[] = $file_type;		 		$msg = '';		$response = array( 'success' => false , 'filename' => '' , 'msg' => '' );		        if(isset($file)){                				//rename file and Clean up filename to get rid of strange characters like spaces etc				$ext = explode( '.' , $file['name'] );				$ext = end( $ext );				$filename = md5( uniqid() ).'.'.$ext;				$filename = JFile::makeSafe( $filename );				$response[ 'filename' ] = $filename;                 if($file['size'] > $max) $msg = JText::_('ONLY_FILES_UNDER').' '.$max;                //Set up the source and destination of the file                 $src = $file['tmp_name'];                $dest = $module_dir . DS . $filename;				                //First check if the file has the right extension, we need jpg only				$file_ext = explode( "/" , $file['type'] );				$file_ext = end( $file_ext );					$file_ext = strtolower( $file_ext );				                if ( in_array( $file_ext , $file_type ) || $file_type == '*') {                    if ( JFile::upload($src, $dest) ) {                       //Redirect to a page of your choice                        $msg = JText::_('FILE_SAVE_AS').' '.$dest;						$response[ 'success' ] = true;                   } else {                        //Redirect and throw an error message                        $msg = JText::_('ERROR_IN_UPLOAD');						$response[ 'success' ] = false;                   }                } else {                   //Redirect and notify user file is not right extension                    $msg = JText::_('FILE_TYPE_INVALID');					$response[ 'success' ] = false;	                }							$response[ 'msg' ] = $msg;	        }        return $response;	}			/**	 *  Task that deletes the list of Informes Seguimiento	 */	public function delete(){				//Het the items picked		$pks = JRequest::getVar( 'cid' );		//Instance a model for each item and delete		foreach ( $pks as $id ) {						// Call the model			$model = $this->getModel( 'caracteristica' );						$model->instance( $id );			$model->delete();					}		$this->setRedirect( "index.php?option=com_referidos&view=caracteristicas" );		return;	}		/*	* redireccion para nueva caracteristicas	*/	public function create(){		$this->setRedirect( JRoute::_( 'index.php?option=com_referidos&view=caracteristicas' , false) );		return;	}		/**	 *  Task that publishes the list of Informes Seguimiento	 */	public function publish(){				//Het the items picked		$pks = JRequest::getVar( 'cid' );		//Instance a model for each item and delete		foreach ( $pks as $id ) {						// Call the model			$model = $this->getModel( 'caracteristica' );			$args = array(				'id_caracteristica' => $id,				'estado_activo' => 0			);						$model->instance( $args );			$model->publish();					}		$this->setRedirect( JRoute::_( "index.php?option=com_referidos&view=caracteristicas" , false) );		return;	}  		/**	 *  Task that unpublishes the list of Informes Seguimiento	 */	public function unpublish(){				//Het the items picked		$pks = JRequest::getVar( 'cid' );		//Instance a model for each item and delete		foreach ( $pks as $id ) {						// Call the model			$model = $this->getModel( 'caracteristica' );			$args = array(				'id_caracteristica' => $id,				'estado_activo' => 1			);						$model->instance( $args );			$model->publish();					}		$this->setRedirect( "index.php?option=com_referidos&view=caracteristicas" );		return;	}      	/**	* Make a model request to publish or unpublish an informe	*	*	*/	public function publicar(){		$id = JRequest::getInt("id");		$model = $this->getModel( 'caracteristica' );		$model->instance( $id );				echo $model->publish( 'bool' );				die();	}		/**	 * task to set the default estado	 */	public function setShow()	{		// Check for request forgeries		$id = JRequest::getInt('id', '');		$model = $this->getModel( 'caracteristica' );				$model->instance( $id );				//echo json_encode( $model->setShow( 'object' ) ); die;				echo $model->setShow( 'bool' );				die();	}	}