<?php// Joomla calls and runtimesdefined( '_JEXEC' ) or die( 'Restricted access' );jimport( 'joomla.application.component.model' );// Begining of the controllerclass ReferidosModelPlan extends ReferidosModelDefault{		/** 	* Object id "id_plan"	* var int	*/	public $id_plan;		/**	* estado del plan	* var char	*/	public $estado_activo;		/**	* nombre del plan	* var string	*/	public $nom_plan;		/**	* descripcion	* var string	*/	public $descripcion;		/**	* fecha de creacion	* var date	*/	public $created;		/**	* id crea	* var int	*/	public $created_by;		/**	* fecha de creacion	* var date	*/	public $modified;		/**	* id modifica	* var int	*/	public $modified_by;		/**	* filas que contendra la matriz	* var char	*/	public $niveles;		/**	* columnas que contendran la matriz	* var char	*/	public $personas_nivel;		/**	* estado del plan	* var char	*/	public $comision_x_persona;	/**	* estado del plan	* var char	*/	public $personas;	/**	* estado del plan	* var int	*/	public $orden;		/**	* estado del plan	* var float	*/	public $valor_pesos;		/**	* estado del plan	* var float	*/	public $valor_dolares;		/**	* si es de pago o gratuito	* var int	*/	public $tipo_pan;		/**	 * redefined Constant for table 	 * @var string	 */	const TABLE = '#__planes';		//constante base para los filtros	const FILTER_STATE = 'filter.referidos.plan.';		/**	 * Attributes Map	 * @var array	 */	protected $attrs_map = array( 			'id_plan'		,	'estado_activo'					,	'nom_plan'		,	'descripcion'		,	'created'		,	'created_by'		,	'modified'		,	'modified_by'		,	'niveles'		,	'personas_nivel'		,	'comision_x_persona'		,	'personas'		,	'orden'			,	'valor_pesos'			,	'valor_dolares'			,	'tipo_plan'	);		/**	* Guarda registro en tabla de relacion plan-caracteristica	*/	public function savePlanCaracteristica( $args = array() ){				$db = JFactory::getDbo();		$model = new stdClass();				// Fetch the model attributes with the $model's var		foreach ( $args as $key=>$valor ) {			$model->$key = $valor;		}				if( !empty( $this->insertId ) ){						$model->id_plan = $this->insertId;					}elseif( !empty( $this->id_plan ) ){						$model->id_plan = $this->id_plan;		}					/*		* hago consulta, para saber si ya existe la categoria para el plan, y		* si existe solo actualizo los valores		*/				$query = $db->getQuery( true );		$query->select( 'id_caracteristica_plan' );		$query->from( '#__caracteristicas_planes' );		$query->where( array( 'id_plan = '.$model->id_plan , 'id_caracteristica = '.$model->id_caracteristica ) );		$db->setQuery( $query );		$id_caracteristica = $db->loadResult();				//var_dump($id_caracteristica);				if( $id_caracteristica )			$model->id_caracteristica_plan = $id_caracteristica;				if( $db->updateObject( '#__caracteristicas_planes' , $model , 'id_caracteristica_plan' , false ))		{ 			return true;		}		elseif( $db->insertObject( '#__caracteristicas_planes', $model ) ){						return true;		}				return false;	}		/**	* Obtengo las caracteristicas del plan	*/	public function getCaracteristicasPlan( $where ,  $params ){				$db = JFactory::getDbo();			if( !is_array( $where ) )			$where = array();				$db = JFactory::getDbo();		$query = $db->getQuery(true);				$query->select( '*' );		$query->from( self::TABLE.' AS a' );		$query->innerJoin( '#__caracteristicas_planes AS b ON a.id_plan = b.id_plan' );		$query->innerJoin( '#__caracteristicas AS c ON b.id_caracteristica = c.id_caracteristica' );				$query->where( 'a.id_plan = '.$this->id_plan , 'AND');				foreach( $where as $key=>$obj ){						if( !is_object($obj) )				continue;						$consulta = $obj->key . $obj->condition . $obj->value . $obj->glue;			$query->where( $consulta );					}				// Order ASC default		if( isset( $params[ 'order' ] ) )			$query->order( $params[ 'order' ] );					// Group By		if( isset( $params[ 'group' ] ) )				$query->group( $params[ 'group' ] );				$db->setQuery( $query );				// loadObject  Or  loadObjectList		if( !isset($params[ 'load' ]) )			$params[ 'load' ] = 'loadObject';				return $db->$params[ 'load' ]();	}		/**	 * Delete Caracteristica plan	 *	 * @param { int } the id of the object or array that contains the id	 * @return { bool/object } the object returned or false otherwise	 */	public static function deleteCaractPlan( $id ){			if( ! is_numeric( $id ) )			return false;				// Delete existing object if the id was passed through		$query = "DELETE FROM #__caracteristicas_planes WHERE id_caracteristica_plan = " . $id;		$db = JFactory::getDbo();		$db->setQuery( $query );			return $db->query();		}		/**	* enviar email a usuario de renovacion de plan	*/	public function sendMailRenovacionPlan( $sendparams = array() ){				$uri = JFactory::getURI();				//parametros para el metodo que obtiene el formulario de pago		$params_pay = array(				'btn_input' => '<input type="image" src="'.$uri->root().'components/com_referidos/assets/images/img-pay.png" alt="Pagar desde Payu Latam" title="Pagar desde Payu Latam" />'			,	'planuser' => $sendparams[ 'planuser' ]			,	'userid' => $sendparams[ 'userid' ]			,	'nomplan' => $this->nom_plan			,	'valorpesos' => number_format( $this->valor_pesos , 2 , '.' , '')			,	'valordolar' => number_format( $this->valor_dolares , 2 , '.' , '')			,	'emailuser' => $sendparams[ 'emailuser' ]			,	'nameuser' => $sendparams[ 'nameuser' ]		);				//destinatari		$para  = $sendparams[ 'emailuser' ];				// subject		$titulo = ucfirst( $sendparams[ 'nameuser' ] ).', necesitas renovar tu plan';				// message		$mensaje = '			<html>				<head>				  <title>Renovaci&oacute;n Plan JooinWorld</title>				</head>				<body>					<div class="content-mail" style="font-family: \'Calibri\', \'Helvetica Neue\'; width: 80%; height:auto; margin:0 auto; padding:0;">						<div class="titulo" style="width:100%; height:61px; background-color:#566EAC; color:#ffffff; padding: 2px 37px;">							<img src="'.$uri->root().'templates/jooinworld-home/images/logo.png">							<!--<span style="color:#CDCBE3; font-size:12px; padding: 5px 10px;">uniendo al mundo</span>-->						</div>						<div class="cuerpo" style="width:100%; padding: 25px; font-size:14px;">							<h3 style="color:#000000">Hola <span style="color: #566EAC;" class="text-blue">'.ucfirst( $sendparams[ 'nameuser' ] ).'</span></h3>							<p style="margin: 20px 0px; text-align:justify;" >							Nesecitas renovar tu plan '.strtoupper($this->nom_plan).', para que no pierdas las comisiones por las personas que has referido, y puedas seguir utilizando este plan para obtener mas personas que pueden llegar a ser referidos tuyos.							</p>							<div class="content-img" style="width:100%; text-align:left;">								<img style="display:inline-block; border: 1px solid #B2B2B2; border-radius:5px; padding: 2px; margin-right: 5px;" src="'. $uri->root() . ( ( !empty($sendparams[ 'thumb' ]) ) ? $sendparams[ 'thumb' ] : 'images/user-Male-thumb.png').'" alt="'.$sendparams[ 'nameuser' ].'" />								<span style="display:inline-block; vertical-align:top; color: #566EAC;" class="text-blue">'.$sendparams[ 'nameuser' ].'</span>							</div>    							<div class="agradecimiento" style="width:100%; text-align:left; margin: 0px 0px 10px 0px;">								<h2 style="color:#000000">Gracias</h2>															</div>							<di style="text-align:center; width:100%;">									'.$this->formPay( $params_pay ).'							</div>						</div>					</div>				</body>			</html>		';				// Para enviar un correo HTML mail, la cabecera Content-type debe fijarse		$cabeceras  = "MIME-Version: 1.0 \r\n";		$cabeceras .= "Content-type: text/html; charset=UTF-8 \r\n";				// Cabeceras adicionales		$cabeceras .= "To: " . $para ." \r\n";		$cabeceras .= "From: soporte@sainetingenieria.com \r\n";				// Mail it		mail( $para, $titulo, $mensaje, $cabeceras);		}		/**	*	*/	protected function formPay( $datas ){					$uri = JFactory::getURI();		$model_pago = new PagoModel();		$Utilities = new Misc();				$url_res = $uri->root().'index.php?option=com_referidos&task=plan.responsepay';		$url_conf = $uri->root().'index.php?option=com_referidos&task=plan.confirmationrenovacion';				$text_encript = $datas[ 'planuser' ].'_'.$datas[ 'userid' ];				$text_encript = $Utilities::Encrypt( $text_encript );		//echo $text_encript; die;				$args = array(				'refVenta' => $text_encript			,	'description' => 'Plan Referidos : '.$datas[ 'nomplan' ]			,	'valor' => number_format( $datas[ 'valorpesos' ] , 2 , '.' , '')			,	'iva' => 0			,	'basevalor' => 0			,	'comprador_email' => $datas[ 'emailuser' ]			,	'comprador_name' => $datas[ 'nameuser' ]			,	'currency' => 'COP'			,	'url_respuesta' => $url_res			,	'url_confirmacion' => $url_conf		);				//instancio la clase de pago y le paso los argumentos		$model_pago->instance( $args );		$model_pago->getForm( $datas[ 'btn_input' ] );	}}?>